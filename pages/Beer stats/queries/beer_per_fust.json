{
  "pluginType": "DB",
  "pluginId": "postgres-plugin",
  "unpublishedAction": {
    "name": "beer_per_fust",
    "datasource": {
      "name": "register",
      "pluginId": "postgres-plugin",
      "messages": [],
      "isAutoGenerated": false,
      "id": "register",
      "deleted": false,
      "policies": [],
      "userPermissions": []
    },
    "pageId": "Beer stats",
    "actionConfiguration": {
      "timeoutInMillisecond": 10000,
      "paginationType": "NONE",
      "encodeParamsToggle": true,
      "body": "WITH new_fust AS (\nSELECT id,\n\t\t\t volume,\n\t\t\t time_of_replacement as fust_placed,\n\t\t\t CASE \n\t\t\t\t\tWHEN lead(time_of_replacement, 1) OVER (ORDER BY time_of_replacement ASC) IS NOT NULL\n\t\t\t\t\t\tTHEN lead(time_of_replacement, 1) OVER (ORDER BY time_of_replacement ASC) \n\t\t\t\t\tELSE NOW()\n\t\t\tEND AS fust_replaced\n\tFROM register.new_fust\n\t),\nnew_fust_cross AS\t(\n\tSELECT nf.id,\n\t\t\t\t\tnf.volume,\n\t\t\t\t\tnf.fust_placed,\n\t\t\t\t\tnf.fust_replaced,\n\t\t\t\t  CASE \n\t\t\t\t\t\tWHEN SUM(single_beer.amount) IS NULL\n\t\t\t\t\t\t\tTHEN 0\n\t\t\t\t\t\tELSE SUM(single_beer.amount)\n\t\t\t\t  END AS no_single_beers,\n\t\t\t\t\tCASE \n\t\t\t\t\t\tWHEN SUM(single_beer.amount * single_beer.price) IS NULL\n\t\t\t\t\t\t\tTHEN 0\n\t\t\t\t\t\tELSE SUM(single_beer.amount * single_beer.price)\n\t\t\t\t  END AS revenue_single_beers,\n\t\t\t\t\tCASE \n\t\t\t\t\t\tWHEN SUM(jug.amount) IS NULL\n\t\t\t\t\t\t\tTHEN 0\n\t\t\t\t\t\tELSE SUM(jug.amount)\n\t\t\t\t  END AS no_jugs,\n\t\t\t\t\tCASE \n\t\t\t\t\t\tWHEN SUM(jug.amount * jug.price) IS NULL\n\t\t\t\t\t\t\tTHEN 0\n\t\t\t\t\t\tELSE SUM(jug.amount * jug.price)\n\t\t\t\t  END AS revenue_jugs,\n\t\t\t\t\tCASE \n\t\t\t\t\t\tWHEN SUM(golden_triangle.amount) IS NULL\n\t\t\t\t\t\t\tTHEN 0\n\t\t\t\t\t\tELSE SUM(golden_triangle.amount)\n\t\t\t\t  END AS no_gts,\n\t\t\t\t\tCASE \n\t\t\t\t\t\tWHEN SUM(golden_triangle.amount * golden_triangle.price) IS NULL\n\t\t\t\t\t\t\tTHEN 0\n\t\t\t\t\t\tELSE SUM(golden_triangle.amount * golden_triangle.price)\n\t\t\t\t  END AS revenue_gts\n\t\n\t\n\tFROM new_fust nf \n\tLEFT JOIN LATERAL (\n\t\tSELECT *\n\t\tFROM dbt.enriched_orders eo\n\t\tWHERE eo.datetime > nf.fust_placed AND eo.datetime < nf.fust_replaced AND eo.product_id = '2'\n\t) single_beer ON true\n\tLEFT JOIN LATERAL (\n\t\tSELECT *\n\t\tFROM dbt.enriched_orders eo\n\t\tWHERE eo.datetime > nf.fust_placed AND eo.datetime < nf.fust_replaced AND eo.product_id = '3'\n\t) jug ON true\n\tLEFT JOIN LATERAL (\n\t\tSELECT *\n\t\tFROM dbt.enriched_orders eo\n\t\tWHERE eo.datetime > nf.fust_placed AND eo.datetime < nf.fust_replaced AND eo.product_id = '27'\n\t) golden_triangle ON true\n\tGROUP BY \n\tnf.id,\n\tnf.volume,\n\tnf.fust_placed,\n\tnf.fust_replaced\n),\nvolume_added AS (\n\tSELECT *,\n\t\t\t\t no_single_beers * 0.25 + no_jugs * 1.5 + no_gts * 1 as total_volume,\n\t\t\t\t revenue_single_beers + revenue_jugs + revenue_gts as total_revenue\n\tFROM new_fust_cross\n)\nSELECT *\nfrom volume_added\n",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ]
    },
    "executeOnLoad": true,
    "dynamicBindingPathList": [],
    "isValid": true,
    "invalids": [],
    "messages": [],
    "jsonPathKeys": [],
    "userSetOnLoad": false,
    "confirmBeforeExecute": false,
    "policies": [],
    "userPermissions": []
  },
  "id": "Beer stats_beer_per_fust",
  "deleted": false,
  "gitSyncId": "634be61322be2805e0a0683b_634daaa4933761600d81bf4b"
}